<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stardew Valley Fishing Minigame</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

        body {
            background-color: #2d2d2d;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            font-family: 'VT323', monospace;
            user-select: none;
            overflow: hidden;
        }

        /* --- Game Container --- */
        #game-area {
            position: relative;
            width: 800px;
            height: 600px;
            background: url('https://stardewvalleywiki.com/mediawiki/images/6/68/Main_Page_header.jpg') no-repeat center center; /* Placeholder BG */
            background-size: cover;
            border: 4px solid #4a3c31;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            image-rendering: pixelated;
        }

        /* --- Start Overlay --- */
        #start-screen {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 100;
        }
        
        button {
            background: #e69d51;
            border: 4px solid #632d0c;
            color: #4a2008;
            font-family: 'VT323', monospace;
            font-size: 2rem;
            padding: 10px 20px;
            cursor: pointer;
            box-shadow: 0 4px 0 #632d0c;
        }
        button:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #632d0c;
        }

        /* --- Fishing UI Container --- */
        #fishing-ui {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 300px;
            background-color: #e2c28e; /* Tan UI border */
            border: 3px solid #6e4016;
            border-radius: 4px;
            display: none; /* Hidden until game starts */
            flex-direction: row;
            padding: 2px;
            box-shadow: 5px 5px 10px rgba(0,0,0,0.5);
        }

        /* --- The Water Column --- */
        #water-column {
            position: relative;
            width: 35px;
            height: 100%;
            background-color: #0d2e57; /* Deep blue background */
            border: 2px solid #5a3512;
            overflow: hidden;
        }

        /* Background water pattern (simple CSS gradient to mimic pixels) */
        #water-column::after {
            content: '';
            position: absolute;
            top:0; left:0; right:0; bottom:0;
            background: linear-gradient(to bottom, #4295d4 0%, #153e70 100%);
            opacity: 0.8;
            z-index: 0;
        }

        /* --- The Green Catch Bar --- */
        #catch-bar {
            position: absolute;
            left: 2px;
            width: 31px;
            height: 60px; /* Dynamic via JS */
            background-color: #85c341;
            border: 1px solid #4a7a21;
            z-index: 2;
            box-shadow: inset 2px 2px 0 rgba(255,255,255,0.4), inset -2px -2px 0 rgba(0,0,0,0.2);
        }

        /* --- The Fish Icon --- */
        #fish {
            position: absolute;
            left: 50%;
            width: 20px;
            height: 20px;
            transform: translateX(-50%);
            z-index: 3;
            transition: top 0.1s linear; /* Smooth visual interpolation */
        }
        
        /* Pixel art fish created with CSS box-shadow for no external assets */
        .pixel-fish {
            width: 2px; height: 2px;
            background: transparent;
            box-shadow: 
                6px 2px #d95763, 8px 2px #d95763, 10px 2px #d95763,
                4px 4px #d95763, 6px 4px #f5ce8c, 8px 4px #d95763, 10px 4px #d95763, 12px 4px #d95763,
                4px 6px #d95763, 6px 6px #f5ce8c, 8px 6px #d95763, 10px 6px #d95763, 12px 6px #d95763,
                6px 8px #d95763, 8px 8px #d95763, 10px 8px #d95763,
                2px 6px #d95763, 0px 4px #d95763;
        }

        /* --- Progress Bar (Right Side) --- */
        #progress-container {
            position: absolute;
            right: -14px;
            bottom: 0;
            width: 10px;
            height: 100%;
            background-color: #222;
            border: 1px solid #5a3512;
            display: flex;
            flex-direction: column-reverse; /* Fill from bottom */
        }

        #progress-fill {
            width: 100%;
            height: 20%;
            background: linear-gradient(to top, #3c9f28, #99e550);
            transition: height 0.05s linear, background 0.2s;
        }

        /* --- Status Text (Perfect, Hit, etc) --- */
        #status-text {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.5rem;
            color: #fff;
            text-shadow: 2px 2px 0 #000;
            white-space: nowrap;
            display: none;
            animation: floatUp 0.5s ease-out;
        }

        @keyframes floatUp {
            0% { transform: translate(-50%, 10px); opacity: 0; }
            100% { transform: translate(-50%, -10px); opacity: 1; }
        }

        /* --- Result Modal --- */
        #result-modal {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: #fffbe8;
            border: 4px solid #d9a066;
            padding: 20px;
            text-align: center;
            display: none;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            z-index: 200;
        }
        #result-modal h2 { margin-top: 0; color: #d95763; }
        
        /* Sparkles for the bar when catching */
        .sparkle {
            position: absolute;
            width: 4px; height: 4px;
            background: yellow;
            pointer-events: none;
            animation: fade 0.5s linear forwards;
        }
        @keyframes fade { 0% { opacity: 1; } 100% { opacity: 0; transform: translateY(-10px); } }

    </style>
</head>
<body>

<div id="game-area">
    <div id="start-screen">
        <h1>Stardew Fishing Sim</h1>
        <p>Click and Hold to raise the bar.</p>
        <p>Keep the fish inside the green bar!</p>
        <button id="start-btn">CAST LINE</button>
    </div>

    <div id="fishing-ui">
        <div id="status-text">HIT!</div>
        
        <div id="water-column">
            <div id="catch-bar"></div>
            <div id="fish">
                <div class="pixel-fish"></div>
            </div>
        </div>

        <div id="progress-container">
            <div id="progress-fill"></div>
        </div>
    </div>

    <div id="result-modal">
        <h2 id="result-title">CAUGHT!</h2>
        <p id="result-desc">Bullhead - 19 in.</p>
        <button id="restart-btn">Fish Again</button>
    </div>
</div>

<script>
    /* --- Game Configuration --- */
    const GAME_HEIGHT = 300; // Total height of UI
    const WATER_HEIGHT = 296; // Internal water height (approx)
    const BAR_HEIGHT = 60;    // Height of green bar
    const FISH_SIZE = 20;
    
    // Physics Constants
    const GRAVITY = 0.4;
    const THRUST = -0.7;      // Upward force when clicking
    const BOUNCE = -0.5;      // Velocity multiplier when hitting bottom
    const DRAG = 0.99;        // Air resistance
    const MAX_VELOCITY = 8;
    
    // Progress Constants
    const CATCH_SPEED = 0.4;  // How fast bar fills when catching
    const LOSE_SPEED = 0.3;   // How fast bar drains when missing
    
    /* --- State Variables --- */
    let isGameRunning = false;
    let isClicking = false;
    let lastTime = 0;
    
    // Entities
    let bar = {
        y: WATER_HEIGHT - BAR_HEIGHT, // Start at bottom
        velocity: 0
    };
    
    let fish = {
        y: 200,
        targetY: 200,
        moveTimer: 0,
        moveSpeed: 1.5,
        behavior: 'mixed' // 'calm', 'sinker', 'floater', 'mixed'
    };
    
    let progress = 20; // Start with some progress (like in game)

    /* --- Elements --- */
    const ui = document.getElementById('fishing-ui');
    const barElem = document.getElementById('catch-bar');
    const fishElem = document.getElementById('fish');
    const progressFill = document.getElementById('progress-fill');
    const startScreen = document.getElementById('start-screen');
    const resultModal = document.getElementById('result-modal');
    const statusText = document.getElementById('status-text');
    const waterColumn = document.getElementById('water-column');

    /* --- Input Handling --- */
    const gameArea = document.getElementById('game-area');

    gameArea.addEventListener('mousedown', () => isClicking = true);
    window.addEventListener('mouseup', () => isClicking = false);
    
    // Touch support for mobile
    gameArea.addEventListener('touchstart', (e) => { e.preventDefault(); isClicking = true; });
    window.addEventListener('touchend', () => isClicking = false);

    document.getElementById('start-btn').addEventListener('click', startGame);
    document.getElementById('restart-btn').addEventListener('click', () => {
        resultModal.style.display = 'none';
        startGame();
    });

    /* --- Core Loop --- */
    function startGame() {
        startScreen.style.display = 'none';
        ui.style.display = 'flex';
        statusText.style.display = 'block';
        statusText.innerText = "HIT!";
        setTimeout(() => statusText.style.display = 'none', 1000);

        // Reset State
        isGameRunning = true;
        progress = 25;
        bar.y = WATER_HEIGHT - BAR_HEIGHT;
        bar.velocity = 0;
        fish.y = WATER_HEIGHT - 50;
        
        lastTime = performance.now();
        requestAnimationFrame(gameLoop);
    }

    function gameLoop(timestamp) {
        if (!isGameRunning) return;

        // Delta time calculation (simplified)
        const dt = 1; // Keeping physics tied to frame rate for simplicity in this prototype

        updatePhysics();
        updateFishAI();
        checkCollision();
        updateVisuals();

        requestAnimationFrame(gameLoop);
    }

    /* --- Physics Engine --- */
    function updatePhysics() {
        // Apply Force
        if (isClicking) {
            bar.velocity += THRUST;
        } else {
            bar.velocity += GRAVITY;
        }

        // Cap Velocity
        bar.velocity = Math.max(Math.min(bar.velocity, MAX_VELOCITY), -MAX_VELOCITY);

        // Apply Position
        bar.y += bar.velocity;

        // Collision with Bottom
        if (bar.y > WATER_HEIGHT - BAR_HEIGHT) {
            bar.y = WATER_HEIGHT - BAR_HEIGHT;
            // Bounce logic
            if (bar.velocity > 0) {
                bar.velocity *= BOUNCE;
            } else {
                bar.velocity = 0;
            }
        }

        // Collision with Top
        if (bar.y < 0) {
            bar.y = 0;
            bar.velocity = 0; // Stop immediately at top
        }
    }

    /* --- Fish AI --- */
    function updateFishAI() {
        fish.moveTimer++;

        // Every X frames, pick a new target position
        if (fish.moveTimer > 50) { // Approx every ~1 second
            fish.moveTimer = 0;
            
            // Random chance to move
            if (Math.random() > 0.3) {
                // Pick random spot within water bounds (minus padding)
                fish.targetY = Math.random() * (WATER_HEIGHT - FISH_SIZE);
            }
        }

        // Move fish towards target
        const diff = fish.targetY - fish.y;
        
        // Smooth movement
        if (Math.abs(diff) > fish.moveSpeed) {
            fish.y += Math.sign(diff) * fish.moveSpeed;
        } else {
            fish.y = fish.targetY;
        }
    }

    /* --- Logic & Rules --- */
    function checkCollision() {
        // Check overlap
        // Bar Rect
        const barTop = bar.y;
        const barBottom = bar.y + BAR_HEIGHT;
        
        // Fish Rect
        const fishTop = fish.y;
        const fishBottom = fish.y + FISH_SIZE;

        // AABB Collision
        // Logic: Is the fish strictly inside or intersecting the bar?
        // Stardew mechanics: The fish just needs to touch the green bar
        const isCatching = (barTop < fishBottom) && (barBottom > fishTop);

        if (isCatching) {
            progress += CATCH_SPEED;
            barElem.style.backgroundColor = '#85c341'; // Bright Green
            // Add visual cue (flash)
            if (Math.random() > 0.8) createSparkle();
        } else {
            progress -= LOSE_SPEED;
            // Flicker/Shake effect could go here
        }

        // Clamp Progress
        if (progress > 100) progress = 100;
        if (progress < 0) progress = 0;

        // Check Win/Loss
        if (progress >= 100) {
            endGame(true);
        } else if (progress <= 0) {
            endGame(false);
        }
    }

    function updateVisuals() {
        // Update DOM positions
        barElem.style.top = `${bar.y}px`;
        fishElem.style.top = `${fish.y}px`;
        
        // Progress Bar
        progressFill.style.height = `${progress}%`;
        
        // Color change based on progress
        if (progress > 70) {
            progressFill.style.background = "linear-gradient(to top, #3c9f28, #99e550)"; // Green
        } else if (progress > 30) {
            progressFill.style.background = "linear-gradient(to top, #d4a941, #f5ce8c)"; // Yellow
        } else {
            progressFill.style.background = "linear-gradient(to top, #d95763, #ff8993)"; // Red
        }
    }

    function createSparkle() {
        const sparkle = document.createElement('div');
        sparkle.className = 'sparkle';
        sparkle.style.left = (Math.random() * 20) + 'px';
        sparkle.style.top = (bar.y + Math.random() * BAR_HEIGHT) + 'px';
        waterColumn.appendChild(sparkle);
        setTimeout(() => sparkle.remove(), 500);
    }

    function endGame(win) {
        isGameRunning = false;
        ui.style.display = 'none';
        resultModal.style.display = 'block';

        const title = document.getElementById('result-title');
        const desc = document.getElementById('result-desc');

        if (win) {
            title.innerText = "CAUGHT!";
            title.style.color = "#3c9f28";
            // Randomize fish name for fun
            const fishNames = ["Bullhead", "Carp", "Chub", "Largemouth Bass"];
            const name = fishNames[Math.floor(Math.random() * fishNames.length)];
            const size = Math.floor(Math.random() * 20) + 10;
            desc.innerText = `${name} - ${size} in.`;
        } else {
            title.innerText = "ESCAPED";
            title.style.color = "#d95763";
            desc.innerText = "Better luck next time...";
        }
    }
</script>

</body>
</html>